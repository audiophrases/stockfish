<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess with Engine Feedback</title>
    <style>
        /* ... your existing styles ... */
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90vw;
        }

        #board {
            width: 400px;
            max-width: 100%;
            margin: 20px auto;
        }

        #engine-output {
            margin-top: 20px;
            text-align: left;
        }

        #analyze-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #analyze-button:hover {
            background-color: #0056b3;
        }
        #analyze-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .highlight-move-from, .highlight-move-to {
            background-color: rgba(255, 255, 0, 0.5) !important;
        }
         #status {
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://unpkg.com/chess.js@1.0.0/dist/chess.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    </head>
<body>
    <div class="container">
        <h1>Chess with Engine Feedback</h1>
        <div id="board"></div>
        <p id="status"></p>
        <div id="engine-output">
            <p>Best Move: <span id="best-move">N/A</span></p>
            <p>Evaluation: <span id="evaluation">N/A</span></p>
        </div>
        <button id="analyze-button">Analyze Position</button>
    </div>

    <script>
        // Ensure jQuery is loaded before trying to use $
        if (typeof $ === 'undefined') {
            alert("jQuery did not load correctly! The application will not work. Please check your internet connection and browser console.");
            // You might want to stop further execution or display a more permanent error message on the page.
            document.body.innerHTML = "<p style='color:red; font-weight:bold; text-align:center; margin-top: 50px;'>Error: Essential library (jQuery) failed to load. Please check the browser console for details and refresh the page.</p>";
            // throw new Error("jQuery not loaded"); // This would stop script execution
        }

        $(document).ready(() => {
            console.log("Document ready. jQuery loaded:", (typeof $ !== 'undefined'));
            console.log("Chessboard function available:", (typeof Chessboard !== 'undefined'));
            console.log("Chess object available:", (typeof Chess !== 'undefined'));


            const boardElement = $('#board');
            const statusElement = $('#status');
            let board = null;
            // Use 'new Chess()' for both chess.js 0.13.4 and 1.x
            let game = new Chess();
            let currentFen = game.fen();
            let stockfish = null;
            const engineOutputElement = $('#engine-output');
            const bestMoveElement = $('#best-move');
            const evaluationElement = $('#evaluation');
            const highlightFromClass = 'highlight-move-from';
            const highlightToClass = 'highlight-move-to';
            let highlightedMoveSquares = [];

            const stockfishEnginePath = './engine/stockfish.js';

            const initBoard = (fen) => {
                console.log("Attempting to initialize board...");
                const boardDiv = document.getElementById('board');
                if (!boardDiv) {
                    console.error("CRITICAL: The <div id='board'></div> was NOT found in the HTML.");
                    statusElement.text("Error: Board HTML element missing.").css('color', 'red');
                    return;
                }
                if (typeof Chessboard === 'undefined') {
                     console.error("CRITICAL: Chessboard.js library is not loaded.");
                    statusElement.text("Error: Chessboard library failed to load.").css('color', 'red');
                    return;
                }
                console.log("<div id='board'> found. FEN to use:", fen);

                const config = {
                    position: fen || 'start',
                    draggable: true,
                    onDragStart: onDragStart,
                    onDrop: onDrop,
                    onSnapEnd: onSnapEnd,
                    pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png',
                    appearSpeed: 200,
                    moveSpeed: 200,
                    snapbackSpeed: 50,
                    snapSpeed: 25,
                    sparePieces: false // Usually false for a game board
                };

                try {
                    if (board && typeof board.destroy === 'function') {
                        console.log("Destroying previous board instance.");
                        board.destroy();
                    }
                    console.log("Calling Chessboard('board', config)...");
                    board = Chessboard('board', config);

                    if (board && typeof board.position === 'function') {
                        console.log("Chessboard object created successfully!");
                    } else {
                        console.error("Chessboard object creation FAILED.");
                    }
                } catch (e) {
                    console.error("ERROR during Chessboard initialization:", e);
                    statusElement.text("Error creating chessboard. Check console.").css('color', 'red');
                }
                if (board) {
                    updateStatus();
                }
            };

            const onDragStart = (source, piece, position, orientation) => {
                if (typeof game === 'undefined' || !game || game.isGameOver()) {
                     console.log("Game over or game object not ready, preventing drag.");
                     return false;
                }
                if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
                // More checks could be added here, e.g., if it's AI's turn in a Player vs AI game.
                return true; // Allow drag if it's the correct player's piece
            };

            const onDrop = (source, target, piece, newPos, oldPos, orientation) => {
                removeHighlight(highlightedMoveSquares, [highlightFromClass, highlightToClass]);
                let move = null;
                try {
                    // The chess.js `move` method is generally robust.
                    // Ensure 'game' is initialized.
                    if (typeof game === 'undefined' || !game) {
                        console.error("Game object not initialized. Cannot make move.");
                        return 'snapback';
                    }
                    move = game.move({
                        from: source,
                        to: target,
                        promotion: 'q'
                    });
                } catch (e) {
                    console.warn("Invalid move attempt in chess.js:", e.message);
                    return 'snapback'; // chess.js might throw an error for some invalid moves
                }

                if (move === null) { // chess.js returns null for illegal moves not caught by its exceptions
                    console.log("Move was illegal, snapping back.", source, target);
                    return 'snapback';
                }

                currentFen = game.fen();
                updateStatus();
                // Do not call board.position(currentFen) here, onSnapEnd will handle it.
            };

            const onSnapEnd = () => {
                // Ensure board is updated to the FEN from chess.js
                if (board && game) {
                    board.position(game.fen());
                }
            };

            const updateStatus = () => {
                 if (typeof game === 'undefined' || !game) {
                    statusElement.text("Game not ready.").css('color', 'orange');
                    return;
                }
                let status = '';
                const moveColor = (game.turn() === 'b' ? 'Black' : 'White');

                if (game.isCheckmate()) {
                    status = 'Game over, ' + moveColor + ' is in checkmate.';
                    statusElement.css('color', 'green');
                } else if (game.isDraw()) {
                    status = 'Game over, drawn position';
                    statusElement.css('color', 'blue');
                } else {
                    status = moveColor + ' to move';
                    if (game.isCheck()) {
                        status += ', ' + moveColor + ' is in check';
                    }
                    statusElement.css('color', 'black');
                }
                statusElement.html(status);
            };


            const initStockfish = () => {
                try {
                    console.log("Initializing Stockfish worker from:", stockfishEnginePath);
                    stockfish = new Worker(stockfishEnginePath);

                    stockfish.onmessage = (event) => {
                        const line = event.data ? String(event.data).trim() : '';
                        console.log('Stockfish MSG:', line);

                        if (line.startsWith('bestmove')) {
                            const parts = line.split(' ');
                            const bestMoveUci = parts[1];
                            bestMoveElement.text(bestMoveUci || "N/A");
                            if (bestMoveUci && bestMoveUci !== '(none)') {
                                visualizeBestMove(bestMoveUci);
                            } else {
                                bestMoveElement.text("No legal moves or ponder hit");
                            }
                        } else if (line.includes('info depth') && (line.includes('score cp') || line.includes('score mate'))) {
                            const cpScoreMatch = line.match(/score cp (-?\d+)/);
                            const mateScoreMatch = line.match(/score mate (-?\d+)/);

                            if (cpScoreMatch) {
                                const score = parseInt(cpScoreMatch[1]);
                                const evalToShow = (score / 100).toFixed(2);
                                evaluationElement.text(evalToShow);
                            } else if (mateScoreMatch) {
                                evaluationElement.text('Mate in ' + mateScoreMatch[1]);
                            }
                        } else if (line === 'uciok') {
                            console.log("Stockfish: UCI OK. Sending isready.");
                            stockfish.postMessage('isready');
                        } else if (line === 'readyok') {
                            console.log('Stockfish is ready.');
                            $('#analyze-button').prop('disabled', false);
                            stockfish.postMessage('ucinewgame'); // Good practice to send after readyok and before first position
                            statusElement.append(' (Engine Ready)');
                        }
                    };

                    stockfish.onerror = (error) => {
                        console.error('Stockfish Worker Error:', error);
                        engineOutputElement.prepend('<p style="color:red;">Stockfish Worker Error. Check console.</p>');
                        $('#analyze-button').prop('disabled', true).text('Engine Error');
                    };

                    stockfish.postMessage('uci'); // Initial command to start UCI mode
                } catch (e) {
                    console.error("Failed to initialize Stockfish Worker:", e);
                    engineOutputElement.prepend('<p style="color:red;">Stockfish JS file not found or worker failed. Place stockfish.js in ./engine/ folder.</p>');
                    $('#analyze-button').prop('disabled', true).text('Engine Unavailable');
                }
            };

            const analyzePosition = () => {
                if (!stockfish || stockfish.readyState === Worker.CLOSED) { // Check if worker is valid
                    console.error('Stockfish engine not initialized, not ready, or has terminated.');
                    bestMoveElement.text('Error');
                    evaluationElement.text('Engine N/A');
                    alert('Stockfish engine is not available. Please check console and ensure engine is in "engine" folder and working.');
                    $('#analyze-button').prop('disabled', true); // Disable if it's truly broken
                    return;
                }

                bestMoveElement.text('Thinking...');
                evaluationElement.text('Thinking...');
                removeHighlight(highlightedMoveSquares, [highlightFromClass, highlightToClass]);

                // Ensure the game object is valid and has a FEN
                if (!game || typeof game.fen !== 'function') {
                    console.error("Game object is not valid for analysis.");
                    bestMoveElement.text('Error');
                    evaluationElement.text('Game state error');
                    return;
                }
                const fenForAnalysis = game.fen();
                console.log("Analyzing FEN:", fenForAnalysis);
                stockfish.postMessage('position fen ' + fenForAnalysis);
                stockfish.postMessage('go depth 15'); // Adjust depth as needed
            };

            const removeHighlight = (squareArray, classNames) => {
                squareArray.forEach(square => {
                    classNames.forEach(className => {
                        // Chessboard.js uses .square-e2, .square-e4 etc for the divs
                        boardElement.find(`.square-${square}`).removeClass(className);
                    });
                });
                squareArray.length = 0;
            };

            const visualizeBestMove = (bestMoveUci) => {
                removeHighlight(highlightedMoveSquares, [highlightFromClass, highlightToClass]);
                if (bestMoveUci && bestMoveUci.length >= 4 && bestMoveUci !== '(none)') {
                    const fromSquare = bestMoveUci.substring(0, 2);
                    const toSquare = bestMoveUci.substring(2, 4);

                    boardElement.find(`.square-${fromSquare}`).addClass(highlightFromClass);
                    boardElement.find(`.square-${toSquare}`).addClass(highlightToClass);
                    highlightedMoveSquares.push(fromSquare, toSquare);
                }
            };

            $('#analyze-button').on('click', () => {
                analyzePosition();
            });

            // --- Initialization ---
            $('#analyze-button').prop('disabled', true); // Disable until Stockfish is ready

            // Check if essential libraries loaded before proceeding
            if (typeof $ === 'undefined' || typeof Chessboard === 'undefined' || typeof Chess === 'undefined') {
                let missing = [];
                if (typeof $ === 'undefined') missing.push("jQuery");
                if (typeof Chessboard === 'undefined') missing.push("Chessboard.js");
                if (typeof Chess === 'undefined') missing.push("Chess.js");
                const errorMsg = "Critical libraries failed to load: " + missing.join(", ") + ". Application cannot start. Check console for CDN/SRI errors.";
                console.error(errorMsg);
                statusElement.text(errorMsg).css('color', 'red');
                // Optionally, replace the body content with this message.
                // document.body.innerHTML = `<p style='color:red; font-weight:bold; text-align:center; margin-top: 50px;'>${errorMsg}</p>`;
            } else {
                initBoard(currentFen); // Initialize the board
                initStockfish();       // Initialize Stockfish
            }
        });
    </script>
</body>
</html>
