<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess with Engine Feedback</title>
<style>
body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#f0f0f0;margin:0;padding:20px;box-sizing:border-box}
.container{background-color:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);text-align:center;max-width:90vw}
#board{width:400px;max-width:100%;margin:20px auto;position:relative}
#engine-output{margin-top:20px;text-align:left}
#analyze-button{margin-top:15px;padding:10px 20px;background-color:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}
#analyze-button:hover{background-color:#0056b3}
#analyze-button:disabled{background-color:#cccccc;cursor:not-allowed}
.highlight-move-from,.highlight-move-to{background-color:rgba(255,255,0,0.5)!important}
#status{margin-top:10px;font-weight:bold}
.move-rating{position:absolute;bottom:5px;right:5px;background:rgba(0,0,0,0.7);color:#fff;font-size:12px;padding:2px 4px;border-radius:3px;pointer-events:none;z-index:5}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.1/chess.min.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
<h1>Chess with Engine Feedback</h1>
<div id="board"></div>
<p id="status"></p>
<div id="engine-output">
<p>Best Move: <span id="best-move">N/A</span></p>
<p>Evaluation: <span id="evaluation">N/A</span></p>
</div>
<button id="analyze-button" disabled>Analyze Position</button>
</div>
<script>
$(function(){
 var boardEl=$('#board');
 var statusEl=$('#status');
 var board=null;
 var game=new Chess();
 var engine;
 var bestEl=$('#best-move');
 var evalEl=$('#evaluation');
 var highlights=[];
 function initBoard(fen){
   if(board&&board.destroy) board.destroy();
   board=Chessboard('board',{
     position:fen||'start',
     draggable:true,
     onDragStart:onDragStart,
     onDrop:onDrop,
     onSnapEnd:onSnapEnd,
     pieceTheme:'https://cdn.jsdelivr.net/npm/@chrisoakman/chessboardjs@1.0.0/dist/img/chesspieces/wikipedia/{piece}.png'
   });
   updateStatus();
 }
 function updateStatus(){
   var turn=game.turn()==='b'?'Black':'White';
   var txt='';
   if(game.in_checkmate()){
     txt='Game over, '+turn+' is in checkmate.';
     statusEl.css('color','green');
   } else if(game.in_draw()){
     txt='Game over, drawn position';
     statusEl.css('color','blue');
   } else {
     txt=turn+' to move'+(game.in_check()?(', '+turn+' is in check'):(''));
     statusEl.css('color','black');
   }
   statusEl.text(txt);
 }
 function onDragStart(src,piece){
   return !(game.game_over()||(game.turn()==='w'&&piece.startsWith('b'))||(game.turn()==='b'&&piece.startsWith('w')));
 }
 function onDrop(src,tgt){
   clearHighlights(); clearRatings();
   var m=game.move({from:src,to:tgt,promotion:'q'});
   if(!m) return 'snapback';
 }
 function onSnapEnd(){
   board.position(game.fen());
   updateStatus();
 }
 function clearHighlights(){
   highlights.forEach(sq=>boardEl.find('.square-'+sq).removeClass('highlight-move-from highlight-move-to'));
   highlights=[];
 }
 function clearRatings(){ boardEl.find('.move-rating').remove(); }
 function initEngine(){
   engine=new Worker('./engine/stockfish.js');
   engine.onmessage=e=>{
     var line=String(e.data).trim();
     if(line==='uciok'){
       engine.postMessage('isready');
     } else if(line==='readyok'){
       $('#analyze-button').prop('disabled',false);
       engine.postMessage('ucinewgame');
       statusEl.append(' (Engine Ready)');
     } else if(line.startsWith('info depth')&&line.includes('score')){
       var cp=line.match(/score cp (-?\d+)/);
       var mate=line.match(/score mate (-?\d+)/);
       if(cp) evalEl.text((parseInt(cp[1],10)/100).toFixed(2));
       else if(mate) evalEl.text('Mate in '+mate[1]);
     } else if(line.startsWith('bestmove')){
       var mv=line.split(' ')[1];
       bestEl.text(mv);
       visualize(mv);
       engine.postMessage('setoption name MultiPV value 1');
     }
   };
   engine.postMessage('uci');
 }
 function visualize(uci){
   clearHighlights();
   if(!uci||uci.length<4) return;
   var f=uci.slice(0,2), t=uci.slice(2,4);
   boardEl.find('.square-'+f).addClass('highlight-move-from');
   boardEl.find('.square-'+t).addClass('highlight-move-to');
   highlights=[f,t];
 }
 function analyze(){
   clearHighlights(); clearRatings();
   bestEl.text('Thinking...');
   evalEl.text('Thinking...');
   engine.postMessage('position fen '+game.fen());
   engine.postMessage('go depth 15');
 }
 $('#analyze-button').on('click',analyze);
 initBoard(game.fen());
 initEngine();
});
</script>
</body>
</html>
