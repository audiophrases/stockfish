<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess with Engine Feedback</title>
  <style>
    .highlight-selection { box-shadow: inset 0 0 0 3px #ff0 !important; }
    body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; margin: 0; padding: 20px; box-sizing: border-box; }
    .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; max-width: 90vw; }
    #board { width: 400px; max-width: 100%; margin: 20px auto; position: relative; }
    #engine-output { margin-top: 20px; text-align: left; }
    #controls { margin-top: 10px; }
    button { margin: 0 5px; padding: 8px 16px; border: none; border-radius: 5px; color: #fff; cursor: pointer; }
    #analyze-button { background-color: #007bff; }
    #analyze-piece-button { background-color: #17a2b8; }
    #flip-button { background-color: #28a745; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .highlight-move-from, .highlight-move-to { background-color: rgba(255,255,0,0.5) !important; }
    #status { margin-top: 10px; font-weight: bold; }
    .move-rating { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; font-size: 12px; padding: 2px 4px; border-radius: 3px; pointer-events: none; z-index: 5; }
  </style>
  <script src="libs/jquery.min.js"></script>
  <link  href="libs/chessboard-1.0.0.min.css" rel="stylesheet" />
  <script src="libs/chessboard-1.0.0.min.js"></script>
  <script src="libs/chess.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Chess with Engine Feedback</h1>
    <div id="board"></div>
    <p id="status"></p>
    <div id="engine-output">
      <p>Best Move: <span id="best-move">N/A</span></p>
      <p>Evaluation: <span id="evaluation">N/A</span></p>
    </div>
    <div id="controls">
      <button id="analyze-button" disabled>Analyze Position</button>
      <button id="analyze-piece-button" disabled>Analyze Moves</button>
      <button id="flip-button">Flip Board</button>
    </div>
  </div>
  <script>
    $(function() {
      var boardEl = $('#board');
      var statusEl = $('#status');
      var board = null;
      var game = new Chess();
      var engine;
      var bestEl = $('#best-move');
      var evalEl = $('#evaluation');
      var highlights = [];
      var selectedSquare = null;
      var isPieceAnalysis = false;

      function initBoard(fen) {
        if (board && board.destroy) board.destroy();
        board = Chessboard('board', {
          position: fen || 'start',
          draggable: true,
          onDragStart: onDragStart,
          onDrop: onDrop,
          onSnapEnd: onSnapEnd,
          orientation: game.turn() === 'b' ? 'black' : 'white',
          pieceTheme: function(piece) {
            if (!piece) return '';
            var color = piece.charAt(0) === 'w' ? 'white' : 'black';
            var map = { 'K': 'king', 'Q': 'queen', 'R': 'rook', 'B': 'bishop', 'N': 'knight', 'P': 'pawn' };
            return 'pieces/' + color + '-' + map[piece.charAt(1)] + '.png';
          }
        });
        updateStatus();
      }

      function updateStatus() {
        var turnColor = game.turn() === 'b' ? 'Black' : 'White';
        var text = '';
        if (game.in_checkmate()) { text = 'Game over, ' + turnColor + ' is in checkmate.'; statusEl.css('color','green'); }
        else if (game.in_draw()) { text = 'Game over, drawn position'; statusEl.css('color','blue'); }
        else { text = turnColor + ' to move' + (game.in_check() ? ', ' + turnColor + ' is in check' : ''); statusEl.css('color','black'); }
        statusEl.text(text);
      }

      function onDragStart(src, piece) {
        return !(game.game_over() || (game.turn() === 'w' && piece.startsWith('b')) || (game.turn() === 'b' && piece.startsWith('w')));
      }

      function onDrop(src, tgt) {
        clearHighlights(); clearRatings();
        var move = game.move({ from: src, to: tgt, promotion: 'q' });
        if (!move) return 'snapback';
      }

      function onSnapEnd() {
        board.position(game.fen());
        updateStatus();
      }

      function clearHighlights() {
        highlights.forEach(function(sq) { boardEl.find('.square-' + sq).removeClass('highlight-move-from highlight-move-to'); });
        highlights = [];
      }

      function clearRatings() { boardEl.find('.move-rating').remove(); }

      function initEngine() {
        engine = new Worker('./engine/stockfish.js');
        engine.onmessage = function(e) {
          var line = String(e.data).trim();
          if (line === 'uciok') engine.postMessage('isready');
          else if (line === 'readyok') { $('#analyze-button').prop('disabled',false); engine.postMessage('ucinewgame'); statusEl.append(' (Engine Ready)'); }
          else if (isPieceAnalysis && line.startsWith('info') && line.includes('multipv')) {
            var cp = line.match(/score cp (-?\d+)/);
            var mate = line.match(/score mate (-?\d+)/);
            var pv = line.match(/pv ([a-h][1-8][a-h][1-8])/);
            if (pv) {
              var dest = pv[1].slice(2);
              var rating = cp ? (parseInt(cp[1],10)/100).toFixed(2) : mate ? 'M'+mate[1] : '';
              boardEl.find('.square-'+dest).append('<div class="move-rating">'+rating+'</div>');
            }
          } else if (line.startsWith('bestmove')) {
            var best = line.split(' ')[1]; bestEl.text(best); visualize(best);
            isPieceAnalysis = false; engine.postMessage('setoption name MultiPV value 1');
          } else if (line.includes('info depth') && line.includes('score') && !isPieceAnalysis) {
            var cp2 = line.match(/score cp (-?\d+)/);
            var mate2 = line.match(/score mate (-?\d+)/);
            if (cp2) evalEl.text((parseInt(cp2[1],10)/100).toFixed(2));
            else if (mate2) evalEl.text('Mate in '+mate2[1]);
          }
        };
        engine.postMessage('uci');
      }

      function visualize(uci) {
        clearHighlights(); if (!uci||uci.length<4) return;
        var from = uci.slice(0,2), to = uci.slice(2,4);
        boardEl.find('.square-'+from).addClass('highlight-move-from');
        boardEl.find('.square-'+to).addClass('highlight-move-to');
        highlights = [from,to];
      }

      function analyzePosition() {
        clearHighlights(); clearRatings(); bestEl.text('Thinking...'); evalEl.text('Thinking...');
        isPieceAnalysis=false; engine.postMessage('setoption name MultiPV value 1');
        engine.postMessage('position fen '+game.fen()); engine.postMessage('go depth 15');
      }

      function analyzePiece(square) {
        clearHighlights(); clearRatings();
        var moves = game.moves({verbose:true}).filter(m=>m.from===square);
        if (!moves.length) return;
        isPieceAnalysis = true;
        engine.postMessage('setoption name MultiPV value '+moves.length);
        engine.postMessage('position fen '+game.fen());
        engine.postMessage('go depth 15 searchmoves '+moves.map(m=>m.from+m.to).join(' '));
      }

      // handlers
      $('#analyze-button').on('click', analyzePosition);
      $('#analyze-piece-button').on('click', function() { if (selectedSquare) analyzePiece(selectedSquare); });
      $('#flip-button').on('click', () => board.flip());
      $('#board').on('click', '.square-55d63', function() {
        boardEl.find('.highlight-selection').removeClass('highlight-selection');
        var cls = $(this).attr('class').split(/\s+/);
        var sq = cls.find(c=>/^square-[a-h][1-8]$/.test(c));
        if (sq) { selectedSquare = sq.replace('square-',''); $(this).addClass('highlight-selection'); $('#analyze-piece-button').prop('disabled',false); }
      });

      initBoard(game.fen()); initEngine();
    });
  </script>
</body>
</html>
