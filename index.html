<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess Editor & Gauge</title>
  <style>
    body { font-family: sans-serif; background: #ccc; margin: 0; padding: 20px; }
    .container { background: #ccc; padding: 20px; border-radius: 8px; max-width: 750px; margin: 40px auto; }
    #controls { text-align: center; margin-bottom: 10px; }
    #controls button { margin: 5px 10px; padding: 8px 16px; border: none; border-radius: 5px; color: #fff; cursor: pointer; display: inline-block; }
    #status { text-align: center; font-weight: bold; margin: 10px 0; }
    #engine-output { text-align: left; margin-bottom: 10px; }
    .board-wrapper { display: inline-flex; align-items: flex-start; }
    #board { width: 400px; height: 400px; position: relative; }
    #gauge { width: 20px; height: 400px; background: #000; margin-left: 10px; position: relative; }
    #gauge-white { width: 100%; background: #fff; position: absolute; bottom: 0; height: 50%; }
    .highlight-move-from, .highlight-move-to { background: rgba(255,255,0,0.5) !important; }
    .highlight-selection { box-shadow: inset 0 0 0 3px #ff0 !important; }
    .move-rating { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; font-size: 12px; padding: 2px 4px; border-radius: 3px; pointer-events: none; z-index: 5; }
  </style>
  <script src="libs/jquery.min.js"></script>
  <link href="libs/chessboard-1.0.0.min.css" rel="stylesheet">
  <script src="libs/chessboard-1.0.0.min.js"></script>
  <script src="libs/chess.min.js"></script>
</head>
<body>
  <div class="container">
    <div id="controls">
      <button id="best-move-button" disabled>Best Move</button>
      <button id="piece-moves-button">Piece Moves</button>
      <button id="gauge-button">Gauge Advantage</button>
      <button id="flip-button">Flip Board</button>
      <button id="edit-button">Edit Mode</button>
    </div>
    <div id="status"></div>
    <div id="engine-output">
      <p>Best Move: <span id="best-move">N/A</span></p>
      <p>Evaluation: <span id="evaluation">N/A</span></p>
    </div>
    <div class="board-wrapper" id="board-wrapper">
      <div id="board"></div>
      <div id="gauge"><div id="gauge-white"></div></div>
    </div>
  </div>
  <script>
    $(function() {
      let board, engine;
      const game = new Chess();
      let orientation = 'white';
      let freezeMode = false, editMode = false, gaugeMode = false, pieceMovesMode = false;
      let clickSource = null;function updateGauge(cp) {
    const v = Math.max(-2000, Math.min(2000, cp));
    $('#gauge-white').css('height', ((v+2000)/4000*100) + '%');
  }

  function renderBoard() {
    $('#board-wrapper').toggleClass('edit-off', !editMode);
    const cfg = {
      position: game.fen(),
      draggable: !freezeMode && !editMode,
      sparePieces: editMode,
      dropOffBoard: editMode ? 'trash' : 'snapback',
      orientation: orientation,
      onDragStart: (s,p) => editMode || (!freezeMode && !game.game_over() && ((game.turn()==='w'&&p[0]==='w')||(game.turn()==='b'&&p[0]==='b'))),
      onDrop: (s,t,p,newPos) => {
        clearHighlights(); clearRatings();
        if(editMode){
          game.clear();
          Object.entries(newPos).forEach(([sq,pp])=>pp&&game.put({type:pp[1].toLowerCase(),color:pp[0]},sq));
          updateStatus(); return;
        }
        if(freezeMode) return 'snapback';
        const m = game.move({from:s,to:t,promotion:'q'});
        if(!m) return 'snapback'; updateStatus();
      },
      onSnapEnd: ()=>!editMode&&board.position(game.fen()),
      pieceTheme: p=>{
        if(!p) return '';
        const c = p[0]==='w'?'white':'black';
        const m={'K':'king','Q':'queen','R':'rook','B':'bishop','N':'knight','P':'pawn'};
        return `pieces/${c}-${m[p[1]]}.png`;
      }
    };
    board&&board.destroy(); board=Chessboard('board',cfg);
    $('#board').off('click.piece').on('click.piece','div.square-55d63',function(){
      const cls=$(this).attr('class').split(/\s+/);
      const sq=cls.find(c=>/^square-[a-h][1-8]$/.test(c)).replace('square-','');
      if(pieceMovesMode) selectPieceMoves(sq);
      else if(!freezeMode && !editMode) clickMove(sq);
    });
  }

  function updateStatus() {
    const t=game.turn()==='b'?'Black':'White';
    const txt=game.in_checkmate()?`Game over, ${t} in checkmate.`:game.in_draw()?'Game over, drawn.':`${t} to move${game.in_check()?`, ${t} in check`:``}`;
    $('#status').text(txt);
  }

  function clearHighlights() { $('#board').find('.highlight-move-from,.highlight-move-to,.highlight-selection').removeClass('highlight-move-from highlight-move-to highlight-selection'); }
  function clearRatings() { $('#board').find('.move-rating').remove(); }

  function initEngine() {
    engine=new Worker('./engine/stockfish.js');
    engine.onmessage=e=>{
      const line=String(e.data).trim();
      if(line==='uciok') engine.postMessage('isready');
      else if(line==='readyok') $('#best-move-button').prop('disabled',false);
      else if(isPieceAnalysis&&line.startsWith('info')&&line.includes('multipv')){
        const cp=line.match(/score cp (-?\d+)/); const mate=line.match(/score mate (-?\d+)/); const pv=line.match(/pv ([a-h][1-8][a-h][1-8])/);
        if(pv){ const d=pv[1].slice(2); const s=cp?(parseInt(cp[1],10)/100).toFixed(2):mate?`M${mate[1]}`:''; $('#board').find(`.square-${d}`).append(`<div class="move-rating">${s}</div>`); }
      }
      else if(line.startsWith('bestmove')){
        if(!gaugeMode){ const b=line.split(' ')[1]; $('#best-move').text(b); visualize(b); }
        isPieceAnalysis=false; engine.postMessage('setoption name MultiPV value 1');
      }
      else if(line.includes('info depth')&&line.includes('score')){
        const cp2=line.match(/score cp (-?\d+)/); const mate2=line.match(/score mate (-?\d+)/);
        if(cp2){ const v=parseInt(cp2[1],10); $('#evaluation').text((v/100).toFixed(2)); updateGauge(v);} else if(mate2){ $('#evaluation').text(`Mate in ${mate2[1]}`); updateGauge(mate2[1]>0?2000:-2000);}          }
    };
    engine.postMessage('uci');
  }

  function visualize(u){ clearHighlights(); if(!u) return; $('#board').find(`.square-${u.slice(0,2)}`).addClass('highlight-move-from'); $('#board').find(`.square-${u.slice(2,4)}`).addClass('highlight-move-to'); }

  function analyzePosition() {
    clearHighlights(); clearRatings(); gaugeMode=false; $('#evaluation').text('Thinking...'); if(!gaugeMode) $('#best-move').text('Thinking...'); engine.postMessage('setoption name MultiPV value 1'); engine.postMessage(`position fen ${game.fen()}`); engine.postMessage('go depth 15'); }

  function selectPieceMoves(sq) {
    clearHighlights(); clearRatings(); $('#board').find(`.square-${sq}`).addClass('highlight-selection');
    const mv=game.moves({verbose:true}).filter(m=>m.from===sq);
    isPieceAnalysis=true; gaugeMode=false; engine.postMessage(`setoption name MultiPV value ${mv.length}`); engine.postMessage(`position fen ${game.fen()}`); engine.postMessage(`go depth 15 searchmoves ${mv.map(m=>m.from+m.to).join(' ')}`);
  }

  function clickMove(sq) {
    if(!clickSource){ const p=game.get(sq); if(!p||p.color!==game.turn())return; clickSource=sq; $('#board').find(`.square-${sq}`).addClass('highlight-selection'); }
    else { const m=game.move({from:clickSource,to:sq,promotion:'q'}); clickSource=null; clearHighlights(); if(m) updateStatus(); }
  }

  function analyzeGauge() { clearHighlights(); clearRatings(); gaugeMode=true; $('#best-move').text(''); $('#evaluation').text('Thinking...'); engine.postMessage('setoption name MultiPV value 1'); engine.postMessage(`position fen ${game.fen()}`); engine.postMessage('go depth 15'); }

  $('#best-move-button').on('click', analyzePosition);
  $('#piece-moves-button').on('click', () => { pieceMovesMode=!pieceMovesMode; freezeMode=pieceMovesMode; $('#piece-moves-button').text(pieceMovesMode?'Continue Playing':'Piece Moves'); clearHighlights(); clearRatings(); renderBoard(); });
  $('#gauge-button').on('click', analyzeGauge);
  $('#flip-button').on('click',()=>{orientation=orientation==='white'?'black':'white';renderBoard();});
  $('#edit-button').on('click',()=>{editMode=!editMode;$('#edit-button').text(editMode?'Exit Edit':'Edit Mode'); renderBoard();});

  renderBoard(); initEngine(); updateStatus();
});

  </script>
</body>
</html>