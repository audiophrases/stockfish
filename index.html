<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess with Engine Feedback</title>
<style>
body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#f0f0f0;margin:0;padding:20px;box-sizing:border-box}
.container{background-color:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);text-align:center;max-width:90vw}
#board{width:400px;max-width:100%;margin:20px auto;position:relative}
.square-55d63{position:relative}
#engine-output{margin-top:20px;text-align:left}
#analyze-button{margin-top:15px;padding:10px 20px;background-color:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}
#analyze-button:hover{background-color:#0056b3}
#analyze-button:disabled{background-color:#cccccc;cursor:not-allowed}
.highlight-move-from,.highlight-move-to{background-color:rgba(255,255,0,0.5)!important}
#status{margin-top:10px;font-weight:bold}
.move-rating{position:absolute;bottom:5px;right:5px;background:rgba(0,0,0,0.7);color:#fff;font-size:12px;padding:2px 4px;border-radius:3px;pointer-events:none;z-index:5}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"crossorigin="anonymous"></script>
<script src="https://unpkg.com/chess.js@1.0.0/dist/chess.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css"crossorigin="anonymous"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
<h1>Chess with Engine Feedback</h1>
<div id="board"></div>
<p id="status"></p>
<div id="engine-output">
<p>Best Move: <span id="best-move">N/A</span></p>
<p>Evaluation: <span id="evaluation">N/A</span></p>
</div>
<button id="analyze-button">Analyze Position</button>
</div>
<script>
$(document).ready(function(){
var boardElement=$('#board');
var statusElement=$('#status');
var board=null;
var game=new Chess();
var stockfish;
var bestMoveElement=$('#best-move');
var evaluationElement=$('#evaluation');
var highlightFromClass='highlight-move-from';
var highlightToClass='highlight-move-to';
var highlightedMoveSquares=[];
var isPieceAnalysis=false;
function initBoard(fen){
 if(board&&board.destroy)board.destroy();
 board=Chessboard('board',{position:fen||'start',draggable:true,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd,pieceTheme:'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'});
 updateStatus();
}
function updateStatus(){
 var moveColor=game.turn()==='b'?'Black':'White';
 var status='';
 if(game.isCheckmate()){status='Game over, '+moveColor+' is in checkmate.';statusElement.css('color','green')}
 else if(game.isDraw()){status='Game over, drawn position';statusElement.css('color','blue')}
 else{status=moveColor+' to move'+(game.isCheck()?', '+moveColor+' is in check':'');statusElement.css('color','black')}
 statusElement.text(status);
}
function onDragStart(source,piece){if(game.isGameOver())return false; if((game.turn()==='w'&&piece.startsWith('b'))||(game.turn()==='b'&&piece.startsWith('w')))return false;return true}
function onDrop(source,target){removeHighlight();clearRatings();var move=game.move({from:source,to:target,promotion:'q'});if(move===null)return'snapback'}
function onSnapEnd(){board.position(game.fen());updateStatus()}
function removeHighlight(){highlightedMoveSquares.forEach(function(sq){boardElement.find('.square-'+sq).removeClass(highlightFromClass).removeClass(highlightToClass)});highlightedMoveSquares=[]}
function clearRatings(){boardElement.find('.move-rating').remove()}
function initStockfish(){
 stockfish=new Worker('./engine/stockfish.js');
 stockfish.onmessage=function(event){
 var line=String(event.data).trim();
 if(line==='uciok')stockfish.postMessage('isready');
 else if(line==='readyok'){$('#analyze-button').prop('disabled',false);stockfish.postMessage('ucinewgame');statusElement.append(' (Engine Ready)')}
 else if(isPieceAnalysis&&line.startsWith('info')&&line.includes('multipv')){
 var mpv=line.match(/multipv (\d+)/);
 var cp=line.match(/score cp (-?\d+)/);
 var mate=line.match(/score mate (-?\d+)/);
 var pv=line.match(/pv ([a-h][1-8][a-h][1-8][qrbn]?)/);
 if(mpv&&pv){
 var rating='';
 if(cp)rating=(parseInt(cp[1],10)/100).toFixed(2);
 else if(mate)rating='M'+mate[1];
 var toSq=pv[1].substring(2);
 boardElement.find('.square-'+toSq).append('<div class="move-rating">'+rating+'</div>')
 }
 }
 else if(line.startsWith('bestmove')){
 var bm=line.split(' ')[1];
 bestMoveElement.text(bm);
 visualizeBestMove(bm);
 stockfish.postMessage('setoption name MultiPV value 1');
 isPieceAnalysis=false;
 }
 else if(line.includes('info depth')&&line.includes('score')){
 var cp=line.match(/score cp (-?\d+)/);
 var mate=line.match(/score mate (-?\d+)/);
 if(cp)evaluationElement.text((parseInt(cp[1],10)/100).toFixed(2));
 else if(mate)evaluationElement.text('Mate in '+mate[1]);
 }
 };
 stockfish.postMessage('uci');
}
function visualizeBestMove(uci){
 removeHighlight();
 if(!uci||uci.length<4)return;
 var from=uci.substring(0,2);
 var to=uci.substring(2,4);
 boardElement.find('.square-'+from).addClass(highlightFromClass);
 boardElement.find('.square-'+to).addClass(highlightToClass);
 highlightedMoveSquares.push(from,to);
}
function analyzePosition(){
 isPieceAnalysis=false;
 clearRatings();
 removeHighlight();
 bestMoveElement.text('Thinking...');
 evaluationElement.text('Thinking...');
 stockfish.postMessage('setoption name MultiPV value 1');
 stockfish.postMessage('position fen '+game.fen());
 stockfish.postMessage('go depth 15');
}
function analyzePiece(square){
 isPieceAnalysis=true;
 clearRatings();
 removeHighlight();
 var moves=game.moves({verbose:true}).filter(function(m){return m.from===square});
 if(!moves.length){alert('No moves from '+square);return;}
 stockfish.postMessage('setoption name MultiPV value '+moves.length);
 stockfish.postMessage('position fen '+game.fen());
 var uciList=moves.map(function(m){return m.from+m.to+(m.promotion||'')}).join(' ');
 stockfish.postMessage('go depth 15 searchmoves '+uciList);
}
$('#analyze-button').on('click',analyzePosition);
$('#board').on('click','.square-55d63',function(){
 var classes=$(this).attr('class').split(/\s+/);
 var sq=classes.find(function(c){return/^square-[a-h][1-8]$/.test(c)});
 if(sq)analyzePiece(sq.replace('square-',''));
});
$('#analyze-button').prop('disabled',true);
initBoard(game.fen());
initStockfish();
});
</script>
</body>
</html>
